/*! lib-doomRender - v0.1.0 - 2018-02-19 - wilkie */
!function(a){function b(a){"use strict";var b=a.DoomRender=function(a,b){var c=this;return c._canvas=b,c};b.prototype.filename=function(){return this._filename},b.loadScript=function(a,b){for(var c="/",d=document.getElementsByTagName("script"),e=0;e<d.length;e++){var f=d[e].src;if(f.match("doomRender[.](min[.])?js$")){c=f,c=c.replace("doomRender.js",""),c=c.replace("doomRender.min.js","");break}}a=c+a;var g=document.getElementsByTagName("head")[0],h=document.createElement("script");h.type="text/javascript",h.src=a,h.onreadystatechange=b,h.onload=b,g.appendChild(h)}}function c(a){a.DoomRender.Canvas=function(){var a=this;return a};e(a),f(a),d(a)}function d(a){var b=a.DoomRender.Canvas.RenderCache=function(a,b){var c=this;return c._cache={},c._canvases=[],c};b.prototype.createCanvas=function(a,b,c){var d=document.createElement("canvas");return d.width=a,d.height=b,this._cache[c]=d,this._canvases.push(d),d},b.prototype.canvasExists=function(a){return a in this._cache},b.prototype.lookupCanvas=function(a){return this._cache[a]}}function e(a){var b=a.DoomRender.Canvas.Renderer=function(){var b=this;return b._cache=new a.DoomRender.Canvas.RenderCache,b._flatSheet=new a.DoomRender.Canvas.TextureSheet(1024,1024),b};b.prototype.getContext=function(a){return a.getContext("2d")},b.prototype.loadSector=function(a){},b.prototype.loadWall=function(a){},b.prototype.fill=function(a,b,c,d,e,f){return a.beginPath(),a.fillStyle=b,a.fillRect(c,d,e,f),this},b.prototype.drawWall=function(a,b,c,d,e){},b.prototype.drawSector=function(a,b,c,d,e){a.smoothingEnabled=!1;var f=(this._flatSheet.storeTexture(b.textureFloor()),b.polygons());a.save(),a.lineWidth=1,a.beginPath(),f.forEach(function(b){b=b.slice().reverse(),a.moveTo((b[0].x-c)*e,(-b[0].y-d)*e),b.slice(1).forEach(function(b){a.lineTo((b.x-c)*e,(-b.y-d)*e)}),a.lineJoin="miter",a.closePath()}),a.clip(),a.beginPath();var g=b.boundingBox();if(g.y=-(g.y+g.height),g.x<0){var h=64- -g.x%64;g.x-=h,g.width+=h}else{var h=g.x%64;g.x-=h,g.width+=h}if(g.y<0){var h=64- -g.y%64;g.y-=h,g.height+=h}else{var h=g.y%64;g.y-=h,g.height+=h}for(var i=0;i<g.height;i+=64)for(var j=0;j<g.width;j+=64)this._flatSheet.drawTextureX2(a,b.textureFloor(),(j+g.x-c)*e,(i+g.y-d)*e,e);a.smoothingEnabled=!0,a.restore(),a.lineWidth=1,a.beginPath(),f.forEach(function(b){b=b.slice().reverse(),a.moveTo((b[0].x-c)*e,(-b[0].y-d)*e),b.slice(1).forEach(function(b){a.lineTo((b.x-c)*e,(-b.y-d)*e)}),a.lineJoin="miter",a.closePath()}),a.strokeStyle="#888888",a.stroke()}}function f(a){var b=a.DoomRender.Canvas.TextureSheet=function(a,b){var c=this;return c._canvas=document.createElement("canvas"),c._canvas.width=a,c._canvas.height=b,c._width=a,c._height=b,c._lookup={},c._count=0,c._curX=0,c._curY=0,c._curHeight=0,c};b.prototype.storeTexture=function(a){if(this.textureExists(a))return this.textureInfo(a);var b=a.rgbaBuffer(),c=this._canvas.getContext("2d");if(this._curX+(a.width()+7)>this._width){if(0==this._curHeight)return;this._curX=0,this._curY+=this._curHeight,this._curHeight=0}for(var d=c.getImageData(this._curX,this._curY,a.width(),a.height()),e=d.data,f=0;f<e.length;f+=4)e[f+0]=b[f+0],e[f+1]=b[f+1],e[f+2]=b[f+2],e[f+3]=255;return c.putImageData(d,this._curX,this._curY),c.putImageData(d,this._curX+a.width(),this._curY,0,0,5,a.height()),c.putImageData(d,this._curX+a.width(),this._curY+a.height(),0,0,5,5),c.putImageData(d,this._curX,this._curY+a.height(),0,0,a.width(),5),ret={x:this._curX,y:this._curY,width:a.width(),height:a.height()},a.namespace()in this._lookup||(this._lookup[a.namespace()]={}),this._lookup[a.namespace()][a.name()]=ret,this._curX+=a.width()+7,a.height()+7>this._curHeight&&(this._curHeight=a.height()+7),ret},b.prototype.textureExists=function(a){return a.namespace()in this._lookup&&a.name()in this._lookup[a.namespace()]},b.prototype.textureInfo=function(a){return this.textureExists(a)?this._lookup[a.namespace()][a.name()]:void 0},b.prototype.drawTexture=function(a,b,c,d,e){var f=this.storeTexture(b);return a.drawImage(this._canvas,f.x,f.y,f.width,f.height,c,d,f.width*e,f.height*e),this},b.prototype.drawTextureX2=function(a,b,c,d,e){var f=this.storeTexture(b);return a.drawImage(this._canvas,f.x,f.y,f.width+5,f.height+5,c,d,(f.width+5)*e,(f.height+5)*e),this}}function g(a){a.DoomRender.Vendor={hello:"hi"};!function(a){}(a.DoomRender.Vendor)}function h(a){a.DoomRender.Orthographic=function(){var a=this;return a};i(a)}function i(a){var b=a.DoomRender.Orthographic.Renderer=function(){var a=this;return a};b.prototype.lookAt=function(a,b,c,d){this._camera.position.set(20,20,20),this._camera.lookAt(0,0,0),this._camera.position.x=b,this._camera.position.z=c,this._camera.position.y=2400,d/=.1,this._camera.left=canvas.clientWidth*d/-2,this._camera.right=canvas.clientWidth*d/2,this._camera.top=canvas.clientHeight*d/2,this._camera.bottom=canvas.clientHeight*d/-2,this._camera.updateProjectionMatrix()},b.prototype.getContext=function(a){var b=this;const c=new THREE.WebGLRenderer({canvas:a});return c.setClearColor(0,1),b.resize(c,a),this.clear(),c},b.prototype.resize=function(a,b,c,d){const e=a;c=c||b.clientWidth,d=d||b.clientHeight,e.setSize(c,d),void 0===this._camera&&(this._camera=new THREE.OrthographicCamera),this._camera.left=c/-2,this._camera.right=c/2,this._camera.top=d/2,this._camera.bottom=d/-2,this._camera.near=0,this._camera.far=64e3,this._camera.updateProjectionMatrix()},b.prototype.fill=function(a,b,c,d,e,f){},b.prototype.drawWall=function(a,b,c,d,e){},b.prototype.loadWall=function(a){},b.prototype.render=function(a){var b=this;a.render(b._scene,b._camera)},b.prototype.interpretBrightness=function(a){return a=Math.max(8,a-64),a=255*(a/160),a=Math.floor(Math.min(a/2,255)),a+256*a+65536*a},b.prototype.drawSector=function(a,b,c,d,e,f){var g=this;b._added,b._added=!0;var h=b.polygons(),i=0;h.forEach(function(a){var c=function(a,c){var d=b.textureFloor();a||(d=b.textureCeiling());const e=g.createTexture(d),f=g.interpretBrightness(b.brightness()),h=new THREE.MeshLambertMaterial({map:e,color:f}),i=new THREE.MeshLambertMaterial({color:16777215}),j=new THREE.MeshBasicMaterial({color:16711680,wireframe:!0});var k=[i];k.push(h),k.push(j);const l=null;return c.faces.forEach(function(d,e){if(d.materialIndex=null,c.vertices[d.a].z==c.vertices[d.b].z&&c.vertices[d.b].z==c.vertices[d.c].z)a?d.materialIndex=1:d.materialIndex=null;else{var f=0,h=0,i=0,j=0;c.vertices[d.a].z==c.vertices[d.b].z?(f=c.vertices[d.a].x,h=c.vertices[d.a].y,i=c.vertices[d.b].x,j=c.vertices[d.b].y):c.vertices[d.a].z==c.vertices[d.c].z?(f=c.vertices[d.a].x,h=c.vertices[d.a].y,i=c.vertices[d.c].x,j=c.vertices[d.c].y):(f=c.vertices[d.b].x,h=c.vertices[d.b].y,i=c.vertices[d.c].x,j=c.vertices[d.c].y);const m=b.lineDefAt(f,h,i,j);if(m){d.materialIndex=l;const n=[m.leftSideDef(),m.rightSideDef()].filter(function(a){return a&&a.sector()!==b})[0],o=[m.leftSideDef(),m.rightSideDef()].filter(function(a){return a&&a.sector()===b})[0];if(n){var p=n.textureLower();if(a||(p=n.textureUpper()),!a&&"F_SKY1"==n.sector().textureCeiling().name()&&o){if(o.sector().textureCeiling().name()==n.sector().textureCeiling().name())return;p||(p=b.textureCeiling())}if(p){const q=g.createTexture(p),r=new THREE.MeshLambertMaterial({map:q,color:g.interpretBrightness(n.sector().brightness())});k.push(r),d.materialIndex=k.length-1,c.faceVertexUvs[0][e].forEach(function(e,f){const g=c.vertices[[d.a,d.b,d.c][f]];m.start().y!=m.end().y&&g.y==m.start().y||m.start().y==m.end().y&&g.x==m.start().x?e.x=0:e.x=m.magnitude();var h=b.neighborFloor()-b.floor();a?h=m.isLowerUnpegged()?b.neighborFloor()-n.sector().ceiling():b.neighborFloor()-o.sector().floor():m.isUpperUnpegged()?o&&(h=-n.sector().ceiling()+o.sector().ceiling()):h=1+(128-p.height()),h-=n.textureY(),e.y-=h,h=0,h+=n.textureX(),e.x+=h}),c.uvsNeedUpdate=!0}}}}}),k},d=a.shape;const e=new THREE.Shape;d=d.slice().reverse(),e.moveTo(d[0].x,d[0].y+i),d.slice(1).forEach(function(a){e.lineTo(a.x,a.y+i)});var f=[];a.holes.forEach(function(a){a=a.reverse();const b=new THREE.Shape;b.moveTo(a[0].x,a[0].y+i),a.slice(1).forEach(function(a){b.lineTo(a.x,a.y+i)}),a.length>2&&f.push(b)}),e.holes=f;const h=b.floor()-b.neighborFloor(),j=new THREE.ExtrudeGeometry(e,{amount:h,bevelEnabled:!1});var k=c(!0,j);const l=new THREE.Mesh(j,k);l.rotation.x=-Math.PI/2,l.position.y=b.neighborFloor(),g._scene.add(l);var d=a.shape;const m=new THREE.Shape;d=d.slice().reverse(),m.moveTo(d[0].x,d[0].y+i),d.slice(1).forEach(function(a){m.lineTo(a.x,a.y+i)}),m.holes=a.holes.map(function(a){const b=new THREE.Shape;return b.moveTo(a[0].x,a[0].y+i),a.slice(1).forEach(function(a){b.lineTo(a.x,a.y+i)}),b});const n=new THREE.ExtrudeGeometry(m,{amount:b.neighborCeiling()-b.ceiling(),bevelEnabled:!1});var k=c(!1,n);const o=new THREE.Mesh(n,k);o.rotation.x=-Math.PI/2,o.position.y=b.ceiling(),g._scene.add(o)});const j=b.lineDefs();j.forEach(function(a){const c=[a.leftSideDef(),a.rightSideDef()].filter(function(a){return a&&a.sector()!==b})[0],d=[a.leftSideDef(),a.rightSideDef()].filter(function(a){return a&&a.sector()===b})[0];var e=c&&d;[c,d].forEach(function(f,h){if(f){const i=new THREE.Shape;var j=h==(e?0:1)?a.start():a.end(),k=h==(e?0:1)?a.end():a.start();i.moveTo(j.x,j.y),i.lineTo(k.x,k.y);const l=f.textureMiddle();var m=[];if(l){var n=b.ceiling()-b.floor();e&&(n=Math.min(n,l.height()));const o=new THREE.ExtrudeGeometry(i,{amount:n,bevelEnabled:!1}),p=g.createTexture(l),q=g.interpretBrightness(f.sector().brightness()),r=new THREE.MeshLambertMaterial({map:p,color:q,transparent:!0});m.push(r),o.faces.forEach(function(b,c){if(b.materialIndex=null,!e||2>c){if(!e&&c>=2){if(1==m.length){const d=new THREE.MeshLambertMaterial({map:p,color:g.interpretBrightness(128),transparent:!1});m.push(d)}b.materialIndex=1}else b.materialIndex=0;o.faceVertexUvs[0][c].forEach(function(c,d){const e=o.vertices[[b.a,b.b,b.c][d]];j.y!=k.y&&e.y==j.y||j.y==k.y&&e.x==j.x?c.x=0:c.x=a.magnitude();var g=0;a.isLowerUnpegged()||(g=-n,g-=f.textureY()),g+=f.textureY(),c.y-=g,g=0,g+=f.textureX(),c.x+=g})}}),o.uvsNeedUpdate=!0;const s=new THREE.Mesh(o,m);s.rotation.x=-Math.PI/2;var t=f.sector().floor();e&&(t=Math.max(c.sector().floor(),d.sector().floor())),s.position.y=t,g._scene.add(s)}}})})},b.prototype.createTexture=function(a){if(this._textureCache=this._textureCache||{},!(a.name()in this._textureCache)){var b=a.width(),c=a.height(),d=a.rgbaBuffer();const e=function(a){return a&&0===(a&a-1)},f=function(a){return a--,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,a++,a};if(e(b)&&e(c)||(b=f(b),c=f(c)),b!=a.width()||c!=a.height()){for(var g=new Uint8Array(b*c*4),h=0;c>h;h++){const i=h%a.height();for(var j=0;b>j;j++){const k=j%a.width();for(var l=0;4>l;l++)g[4*(h*b+j)+l]=d[4*(i*a.width()+k)+l]}}d=g}var m=new THREE.DataTexture(d,b,c,THREE.RGBAFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.RepeatWrapping,THREE.RepeatWrapping);m.repeat.set(1/b,1/c),m.needsUpdate=!0,this._textureCache[a.name()]=m}return this._textureCache[a.name()]},b.prototype.loadSector=function(a){},b.prototype.clear=function(){if(this._camera){const a=new THREE.Scene;a.add(this._camera),a.add(new THREE.AmbientLight(16777215)),a.add(new THREE.AmbientLight(16777215));var b=new THREE.DirectionalLight;a.add(b),b.position.set(-500,200,300),this._scene=a}}}function j(a){var b=a.DoomRender.Viewport=function(b,c,d,e,f,g,h){var i=this;return i._type=b,i._world=c,i._width=g,i._height=h,i.reset(),"canvas"===b?i._renderer=new a.DoomRender.Canvas.Renderer:"orthographic"===b&&(i._renderer=new a.DoomRender.Orthographic.Renderer),i};b.prototype.boundingBox=function(){return{x:this._worldX,y:this._worldY,width:this._width*(1/this._scale),height:this._height*(1/this._scale)}},b.prototype.reset=function(){self._worldX=0,self._worldY=0,self._scale=1},b.prototype.resize=function(a,b,c){return this._width=b||a.clientWidth,this._height=c||a.clientHeight,this._renderer&&this._context&&this._renderer.resize(this._context,a,b,c),this},b.prototype.x=function(a){return void 0===a?this._worldX:(this._worldX=a,this)},b.prototype.y=function(a){return void 0===a?this._worldY:(this._worldY=a,this)},b.prototype.center=function(a,b){if(a instanceof Object){var c=a;return c.y=-(c.y+c.height),this.center(c.x+c.width/2,c.y+c.height/2)}return void 0===b?{x:this.x(),y:this.y()}:(this.x(a),this.y(b),this)},b.prototype.zoom=function(a){if(void 0===a)return this._scale;var b=this.center();return this._scale=a,this.center(b.x,b.y),this},b.prototype.isVisible=function(a){function b(a,b){return!(b.x>a.x+a.width||b.x+b.width<a.x||b.y>a.y+a.height||b.y+b.height<a.y)}var c=a.boundingBox(),d=this.boundingBox();return c.y=-(c.y+c.height),b(c,d)},b.prototype.prepare=function(a,b,c){var d=this;if(d._world){d._context=d._renderer.getContext(a),d._renderer.lookAt(d._context,d._worldX,d._worldY,d._scale),d._renderer.fill(d._context,"black",0,0,d._width,d._height);var e=d._world.level().boundingBox(),f=d._world.level().sectors(),g=0;f.forEach(function(a){g+=1,d._renderer.drawSector(d._context,a,e,d._worldX,d._worldY,d._scale)});var h=d._world.level().lineDefs();h.forEach(function(a){d._renderer.drawWall(d._context,a,d._worldX,d._worldY,d._scale)}),d._prepared=!0,d._renderer.render(d._context)}return this},b.prototype.render=function(a,b,c){return this._prepared||this.prepare(a,b,c),this._prepared&&this._renderer&&this._context&&(this._renderer.lookAt(this._context,this._worldX,this._worldY,this._scale),this._renderer.render(this._context)),this},b.prototype.world=function(a){var b=this;if(void 0===a)return b._world;b._world=a,this._renderer.clear(),this._prepared=!1;var c=b._world.level().sectors(),d=0;c.forEach(function(a){d+=1,b._renderer.loadSector(a)});var e=b._world.level().lineDefs();return e.forEach(function(a){b._renderer.loadWall(a)}),b}}function k(a){var b=a.DoomRender.World=function(a){var b=this;return b._level=a,b};b.prototype.level=function(){return this._level}}var l=Function,m=(new l("return this")(),function(a){return b(a),c(a),k(a),j(a),h(a),g(a),a.initDoomRender});"function"==typeof define&&define.amd?define(function(){return m({})}):m(this)}(this);